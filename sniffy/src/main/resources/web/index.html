<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/webjars/bootstrap/3.3.7/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="/webjars/bootstrap-switch/3.3.3/dist/css/bootstrap3/bootstrap-switch.min.css"/>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="/webjars/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="/webjars/respond/1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>
<body>
    <h1>Sniffy connection status</h1>
    <table class="table table-hover">
        <thead>
        <tr>
            <th class="col-md-6">URL</th>
            <th class="col-md-4">Username</th>
            <th class="col-md-2">Status</th>
        </tr>
        </thead>
        <tbody id="sniffy-datasource-registry">
        </tbody>
    </table>
    <table class="table table-hover">
        <thead>
        <tr>
            <th class="col-md-6">Host</th>
            <th class="col-md-4">Port</th>
            <th class="col-md-2">Status</th>
        </tr>
        </thead>
        <tbody id="sniffy-socket-registry">
        </tbody>
    </table>
    <table class="table table-hover">
        <thead>
        <tr>
            <th class="col-md-10">Settings</th>
            <th class="col-md-2"></th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="col-md-10">
                <label for="persistent">Keep the fault tolerance settings after server restart</label>
            </td>
            <td class="col-md-2">
                <input type="checkbox" data-toggle="toggle" id="persistent"/>
            </td>
        </tr>
        </tbody>
    </table>
    <button id="reload">Refresh</button>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/webjars/jquery/1.12.4/dist/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/webjars/bootstrap/3.3.7/dist/js/bootstrap.min.js"></script>
<script src="/webjars/bootstrap-switch/3.3.3/dist/js/bootstrap-switch.min.js"></script>
<script>

function reload() {
    $.ajax({
        url: '/connectionregistry/',
        dataType: "json"
    }).done(function (data) {
        $('#sniffy-datasource-registry').empty();

        if (true === data.persistent) {
            $('#persistent').bootstrapSwitch('state', true, true);
        } else {
            $('#persistent').bootstrapSwitch('state', false, true);
        }

        if (data.dataSources) $.each(data.dataSources, function (i, item) {
            var toggleButton;
            $('<tr>').append(
                $('<td>').text(item.url),
                $('<td>').text(item.userName),
                $('<td>').append(
                    toggleButton = $('<input type="checkbox" data-toggle="toggle">')
                )
            ).appendTo('#sniffy-datasource-registry');
            if (item.status === 'OPEN') {
                toggleButton.attr('checked', true);
            }
            toggleButton.bootstrapSwitch({
                'size': 'mini',
                'onSwitchChange': function (event, state) {
                    $.ajax({
                        url: '/connectionregistry/datasource/' + encodeURIComponent(encodeURIComponent(item.url)) + '/' + encodeURIComponent(encodeURIComponent(item.userName)),
                        type: state ? 'POST' : 'DELETE',
                        success: function (result) {
                            console.log(result);
                        }
                    });
                }
            });
        });

        $('#sniffy-socket-registry').empty();
        if (data.sockets) $.each(data.sockets, function (i, item) {
            var toggleButton;
            $('<tr>').append(
                $('<td>').text(item.host),
                $('<td>').text(item.port),
                $('<td>').append(
                    toggleButton = $('<input type="checkbox" data-toggle="toggle">')
                )
            ).appendTo('#sniffy-socket-registry');
            if (item.status === 'OPEN') {
                toggleButton.attr('checked', true);
            }
            toggleButton.bootstrapSwitch({
                'size': 'mini',
                'onSwitchChange': function (event, state) {
                    $.ajax({
                        url: '/connectionregistry/socket/' + encodeURIComponent(encodeURIComponent(item.host)) + '/' + encodeURIComponent(encodeURIComponent(item.port)),
                        type: state ? 'POST' : 'DELETE',
                        success: function (result) {
                            console.log(result);
                        }
                    });
                }
            });
        });

    });
}

$(document).ready(function() {
    $('#persistent').bootstrapSwitch({
        'size': 'mini',
        'onSwitchChange': function (event, state) {
            $.ajax({
                url: '/connectionregistry/persistent/',
                type: state ? 'POST' : 'DELETE',
                success: function (result) {
                    console.log(result);
                }
            });
        }
    });
    reload();
    $("#reload").click(reload);
});
</script>
</body>
</html>