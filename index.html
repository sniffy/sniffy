<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on https://github.com/jonrohan -->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" href="stylesheets/github-dark.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/script.js"></script>

  <title>Jdbc-sniffer</title>
  <meta name="description" content="JDBC Sniffer">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">Jdbc-sniffer</h1>
    </header>
    <div id="container">
      <p class="tagline">JDBC Sniffer</p>
      <div id="main" role="main">
        <div class="download-bar">
        <div class="inner">
          <a href="https://github.com/bedrin/jdbc-sniffer/tarball/master" class="download-button tar"><span>Download</span></a>
          <a href="https://github.com/bedrin/jdbc-sniffer/zipball/master" class="download-button zip"><span>Download</span></a>
          <a href="https://github.com/bedrin/jdbc-sniffer" class="code">View Jdbc-sniffer on GitHub</a>
        </div>
        <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">
          <h1>
<a id="jdbc-sniffer" class="anchor" href="#jdbc-sniffer" aria-hidden="true"><span class="octicon octicon-link"></span></a>JDBC Sniffer</h1>

<p><a href="https://gitter.im/bedrin/jdbc-sniffer?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Join the chat at https://gitter.im/bedrin/jdbc-sniffer"></a>
<a href="https://travis-ci.org/bedrin/jdbc-sniffer"><img src="https://travis-ci.org/bedrin/jdbc-sniffer.svg?branch=master" alt="CI Status"></a>
<a href="https://coveralls.io/r/bedrin/jdbc-sniffer?branch=master"><img src="https://coveralls.io/repos/bedrin/jdbc-sniffer/badge.png?branch=master" alt="Coverage Status"></a>
<a href="https://maven-badges.herokuapp.com/maven-central/com.github.bedrin/jdbc-sniffer"><img src="https://maven-badges.herokuapp.com/maven-central/com.github.bedrin/jdbc-sniffer/badge.svg?style=flat" alt="Maven Central"></a>
<a href="https://bintray.com/bedrin/github/jdbc-sniffer/_latestVersion"><img src="https://api.bintray.com/packages/bedrin/github/jdbc-sniffer/images/download.svg" alt="Download"> </a></p>

<p>JDBC Sniffer counts the number of executed SQL queries and provides an API for validating them
It is designed for unit tests and allows you to test if particular method doesn't make more than N SQL queries
Especially it's useful to catch the ORM <a href="http://stackoverflow.com/questions/97197/what-is-the-n1-selects-issue">N+1 problem</a> at early stages </p>

<div class="highlight highlight-java"><pre><span class="pl-k">try</span> (<span class="pl-smi">Spy</span> s <span class="pl-k">=</span> <span class="pl-smi">Sniffer</span><span class="pl-k">.</span>expectAtMostOnce(<span class="pl-smi">Query</span><span class="pl-c1"><span class="pl-k">.</span>SELECT</span>)<span class="pl-k">.</span>expectNever(<span class="pl-smi">Threads</span><span class="pl-c1"><span class="pl-k">.</span>OTHERS</span>);
     <span class="pl-smi">Statement</span> statement <span class="pl-k">=</span> connection<span class="pl-k">.</span>createStatement()) {
    statement<span class="pl-k">.</span>execute(<span class="pl-s"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
    <span class="pl-c">// JDBC Sniffer will throw an Exception if you execute query other than SELECT or uncomment line below</span>
    <span class="pl-c">//statement.execute("SELECT 1 FROM DUAL");</span>
}</pre></div>

<p>You can also use JDBC Sniffer in your test environments to see the number of SQL queries executed by each HTTP request.
Just add it to your <code>web.xml</code> file:</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">filter</span>&gt;
    &lt;<span class="pl-ent">filter-name</span>&gt;sniffer&lt;/<span class="pl-ent">filter-name</span>&gt;
    &lt;<span class="pl-ent">filter-class</span>&gt;com.github.bedrin.jdbc.sniffer.servlet.SnifferFilter&lt;/<span class="pl-ent">filter-class</span>&gt;
    &lt;<span class="pl-ent">init-param</span>&gt;
        &lt;<span class="pl-ent">param-name</span>&gt;inject-html&lt;/<span class="pl-ent">param-name</span>&gt;
        &lt;<span class="pl-ent">param-value</span>&gt;true&lt;/<span class="pl-ent">param-value</span>&gt;
    &lt;/<span class="pl-ent">init-param</span>&gt;
&lt;/<span class="pl-ent">filter</span>&gt;
&lt;<span class="pl-ent">filter-mapping</span>&gt;
    &lt;<span class="pl-ent">filter-name</span>&gt;sniffer&lt;/<span class="pl-ent">filter-name</span>&gt;
    &lt;<span class="pl-ent">url-pattern</span>&gt;/*&lt;/<span class="pl-ent">url-pattern</span>&gt;
&lt;/<span class="pl-ent">filter-mapping</span>&gt;</pre></div>

<p>Restart your server and you will see the number of queries in bottom right corner of your app:</p>

<p><img src="https://bedrin.github.io/jdbc-sniffer/SnifferFilterInjectHtml.png" alt="SnifferFilterInjectHtml"></p>

<p>Click on the icon to see the actual queries and their elapsed time:</p>

<p><img src="https://bedrin.github.io/jdbc-sniffer/SnifferFilterViewQueries.png" alt="SnifferFilterViewQueries.png"></p>

<h1>
<a id="maven" class="anchor" href="#maven" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maven</h1>

<p>JDBC Sniffer is available from Maven Central repository</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.github.bedrin&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;jdbc-sniffer&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;2.3.3&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>For Gradle users:</p>

<div class="highlight highlight-javascript"><pre>dependencies {
    compile <span class="pl-s"><span class="pl-pds">'</span>com.github.bedrin:jdbc-sniffer:2.3.3<span class="pl-pds">'</span></span>
}</pre></div>

<h1>
<a id="download" class="anchor" href="#download" aria-hidden="true"><span class="octicon octicon-link"></span></a>Download</h1>

<p><a href="https://bintray.com/bedrin/github/jdbc-sniffer/view?source=watch"><img src="https://www.bintray.com/docs/images/bintray_badge_color.png" alt='Get automatic notifications about new "jdbc-sniffer" versions'> </a></p>

<ul>
<li>
<a href="https://github.com/bedrin/jdbc-sniffer/releases/download/2.3.3/jdbc-sniffer-2.3.3.jar">jdbc-sniffer-2.3.3.jar</a> (<a href="https://bintray.com/artifact/download/bedrin/github/jdbc-sniffer-2.3.3.jar">bintray mirror</a>)</li>
<li>
<a href="https://github.com/bedrin/jdbc-sniffer/releases/download/2.3.3/jdbc-sniffer-2.3.3-sources.jar">jdbc-sniffer-2.3.3-sources.jar</a> (<a href="https://bintray.com/artifact/download/bedrin/github/jdbc-sniffer-2.3.3-sources.jar">bintray mirror</a>)</li>
<li>
<a href="https://github.com/bedrin/jdbc-sniffer/releases/download/2.3.3/jdbc-sniffer-2.3.3-javadoc.jar">jdbc-sniffer-2.3.3-javadoc.jar</a> (<a href="https://bintray.com/artifact/download/bedrin/github/jdbc-sniffer-2.3.3-javadoc.jar">bintray mirror</a>)</li>
</ul>

<h1>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h1>

<p>Simply add jdbc-sniffer.jar to your classpath and add <code>sniffer:</code> prefix to the JDBC connection url
For example <code>jdbc:h2:~/test</code> should be changed to <code>sniffer:jdbc:h2:mem:</code>
The sniffer JDBC driver class name is <code>com.github.bedrin.jdbc.sniffer.MockDriver</code></p>

<p>HTML injection is configured in <code>web.xml</code> file:</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">filter</span>&gt;
    &lt;<span class="pl-ent">filter-name</span>&gt;sniffer&lt;/<span class="pl-ent">filter-name</span>&gt;
    &lt;<span class="pl-ent">filter-class</span>&gt;com.github.bedrin.jdbc.sniffer.servlet.SnifferFilter&lt;/<span class="pl-ent">filter-class</span>&gt;
    &lt;<span class="pl-ent">init-param</span>&gt;
        <span class="pl-c">&lt;!-- </span>
<span class="pl-c">        Enables injection of JDBC Sniffer toolbar to HTML</span>
<span class="pl-c">        If disabled the html remains untouched</span>
<span class="pl-c">        You still can get the number of executed queries from X-Sql-Queries HTTP header</span>
<span class="pl-c">         --&gt;</span>
        &lt;<span class="pl-ent">param-name</span>&gt;inject-html&lt;/<span class="pl-ent">param-name</span>&gt;
        &lt;<span class="pl-ent">param-value</span>&gt;true&lt;/<span class="pl-ent">param-value</span>&gt; <span class="pl-c">&lt;!-- default: false --&gt;</span>
    &lt;/<span class="pl-ent">init-param</span>&gt;
    &lt;<span class="pl-ent">init-param</span>&gt;
        <span class="pl-c">&lt;!-- Allows disabling the JDBC Sniffer filter in web.xml --&gt;</span>
        &lt;<span class="pl-ent">param-name</span>&gt;enabled&lt;/<span class="pl-ent">param-name</span>&gt;
        &lt;<span class="pl-ent">param-value</span>&gt;true&lt;/<span class="pl-ent">param-value</span>&gt; <span class="pl-c">&lt;!-- default: true --&gt;</span>
    &lt;/<span class="pl-ent">init-param</span>&gt;
    &lt;<span class="pl-ent">init-param</span>&gt;
        <span class="pl-c">&lt;!-- Allows excluding some of the request URL's from Sniffer filter --&gt;</span>
        &lt;<span class="pl-ent">param-name</span>&gt;exclude-pattern&lt;/<span class="pl-ent">param-name</span>&gt;
        &lt;<span class="pl-ent">param-value</span>&gt;^/vets.html$&lt;/<span class="pl-ent">param-value</span>&gt; <span class="pl-c">&lt;!-- optional --&gt;</span>
    &lt;/<span class="pl-ent">init-param</span>&gt;
&lt;/<span class="pl-ent">filter</span>&gt;
&lt;<span class="pl-ent">filter-mapping</span>&gt;
    &lt;<span class="pl-ent">filter-name</span>&gt;sniffer&lt;/<span class="pl-ent">filter-name</span>&gt;
    &lt;<span class="pl-ent">url-pattern</span>&gt;/*&lt;/<span class="pl-ent">url-pattern</span>&gt;
&lt;/<span class="pl-ent">filter-mapping</span>&gt;</pre></div>

<h1>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h1>

<p>Following test shows the main ways of integrating JDBC Sniffer into your project:</p>

<div class="highlight highlight-java"><pre><span class="pl-k">import</span> <span class="pl-smi">com.github.bedrin.jdbc.sniffer.Sniffer</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.github.bedrin.jdbc.sniffer.Spy</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.github.bedrin.jdbc.sniffer.Threads</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.github.bedrin.jdbc.sniffer.Expectation</span>;
<span class="pl-k">import</span> <span class="pl-smi">com.github.bedrin.jdbc.sniffer.junit.QueryCounter</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.junit.Rule</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.junit.Test</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.sql.Connection</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.sql.DriverManager</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.sql.SQLException</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.sql.Statement</span>;

<span class="pl-k">import static</span> <span class="pl-smi">org.junit.Assert.*</span>;

<span class="pl-k">public</span> <span class="pl-k">class</span> <span class="pl-en">UsageTest</span> {

    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testVerifyApi</span>() <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-c">// Just add sniffer: in front of your JDBC connection URL in order to enable sniffer</span>
        <span class="pl-smi">Connection</span> connection <span class="pl-k">=</span> <span class="pl-smi">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s"><span class="pl-pds">"</span>sniffer:jdbc:h2:mem:<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        <span class="pl-c">// Spy holds the amount of queries executed till the given amount of time</span>
        <span class="pl-c">// It acts as a base for further assertions</span>
        <span class="pl-smi">Spy</span> spy <span class="pl-k">=</span> <span class="pl-smi">Sniffer</span><span class="pl-k">.</span>spy();
        <span class="pl-c">// You do not need to modify your JDBC code</span>
        connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
        assertEquals(<span class="pl-c1">1</span>, spy<span class="pl-k">.</span>executedStatements());
        <span class="pl-c">// Sniffer.verifyAtMostOnce() throws an AssertionError if more than one query was executed;</span>
        spy<span class="pl-k">.</span>verifyAtMostOnce();
        <span class="pl-c">// Sniffer.verifyNever(Threads.OTHERS) throws an AssertionError if at least one query was executed</span>
        <span class="pl-c">// by the thread other than then current one</span>
        spy<span class="pl-k">.</span>verifyNever(<span class="pl-smi">Threads</span><span class="pl-c1"><span class="pl-k">.</span>OTHERS</span>);
    }

    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testFunctionalApi</span>() <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-c">// Just add sniffer: in front of your JDBC connection URL in order to enable sniffer</span>
        <span class="pl-k">final</span> <span class="pl-smi">Connection</span> connection <span class="pl-k">=</span> <span class="pl-smi">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s"><span class="pl-pds">"</span>sniffer:jdbc:h2:mem:<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        <span class="pl-c">// Sniffer.execute() method executes the lambda expression and returns an instance of Spy</span>
        <span class="pl-c">// which provides methods for validating the number of executed queries in given lambda</span>
        <span class="pl-smi">Sniffer</span><span class="pl-k">.</span>execute(() <span class="pl-k">-</span><span class="pl-k">&gt;</span> connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>))<span class="pl-k">.</span>verifyAtMostOnce();
    }

    <span class="pl-k">@Test</span>
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testResourceApi</span>() <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-c">// Just add sniffer: in front of your JDBC connection URL in order to enable sniffer</span>
        <span class="pl-k">final</span> <span class="pl-smi">Connection</span> connection <span class="pl-k">=</span> <span class="pl-smi">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s"><span class="pl-pds">"</span>sniffer:jdbc:h2:mem:<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        <span class="pl-c">// You can use Sniffer in a try-with-resource block using expect methods instead of verify</span>
        <span class="pl-c">// When the try-with-resource block is completed, JDBC Sniffer will verify all the expectations defined</span>
        <span class="pl-k">try</span> (@SuppressWarnings(<span class="pl-s"><span class="pl-pds">"</span>unused<span class="pl-pds">"</span></span>) <span class="pl-smi">Spy</span> s <span class="pl-k">=</span> <span class="pl-smi">Sniffer</span><span class="pl-k">.</span>expectAtMostOnce()<span class="pl-k">.</span>expectNever(<span class="pl-smi">Threads</span><span class="pl-c1"><span class="pl-k">.</span>OTHERS</span>);
             <span class="pl-smi">Statement</span> statement <span class="pl-k">=</span> connection<span class="pl-k">.</span>createStatement()) {
            statement<span class="pl-k">.</span>execute(<span class="pl-s"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
        }
    }

    <span class="pl-c">// Integrate JDBC Sniffer to your test using @Rule annotation and a QueryCounter field</span>
    <span class="pl-k">@Rule</span>
    <span class="pl-k">public</span> <span class="pl-k">final</span> <span class="pl-smi">QueryCounter</span> queryCounter <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-smi">QueryCounter</span>();

    <span class="pl-c">// Now just add @Expectation or @Expectations annotations to define number of queries allowed for given method</span>
    <span class="pl-k">@Test</span>
    <span class="pl-k">@Expectation</span>(<span class="pl-c1">1</span>)
    <span class="pl-k">public</span> <span class="pl-k">void</span> <span class="pl-en">testJUnitIntegration</span>() <span class="pl-k">throws</span> <span class="pl-smi">SQLException</span> {
        <span class="pl-c">// Just add sniffer: in front of your JDBC connection URL in order to enable sniffer</span>
        <span class="pl-k">final</span> <span class="pl-smi">Connection</span> connection <span class="pl-k">=</span> <span class="pl-smi">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s"><span class="pl-pds">"</span>sniffer:jdbc:h2:mem:<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        <span class="pl-c">// Do not make any changes in your code - just add the @Rule QueryCounter and put annotations on your test method</span>
        connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
    }

}</pre></div>

<h1>
<a id="integrating-with-test-frameworks" class="anchor" href="#integrating-with-test-frameworks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Integrating with test frameworks</h1>

<p>JDBC Sniffer provides integration with popular testing frameworks - see our wiki for details</p>

<ul>
<li><a href="https://github.com/bedrin/jdbc-sniffer/wiki/JUnit">JUnit</a></li>
<li><a href="https://github.com/bedrin/jdbc-sniffer/wiki/Spring-Framework">Spring Framework</a></li>
<li><a href="https://github.com/bedrin/jdbc-sniffer/wiki/Spock-Framework">Spock Framework</a></li>
<li><a href="https://github.com/bedrin/jdbc-sniffer/wiki/Test-NG">Test NG</a></li>
</ul>

<h1>
<a id="building" class="anchor" href="#building" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building</h1>

<p>JDBC sniffer is built using JDK8+ and Maven 3.2+ - just checkout the project and type <code>mvn install</code>
JDK8 is required only for building the project - once it's built, you can use JDBC Sniffer with any JRE 1.5+</p>

<h1>
<a id="contribute" class="anchor" href="#contribute" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contribute</h1>

<p>You are most welcome to contribute to JDBC Sniffer!</p>

<p>Read the <a href="https://github.com/bedrin/jdbc-sniffer/blob/master/CONTRIBUTING.md">Contribution guidelines</a></p>
        </article>
      </div>
    </div>
    <footer>
      <div class="owner">
      <p><a href="https://github.com/bedrin" class="avatar"><img src="https://avatars0.githubusercontent.com/u/4654384?v=3&amp;s=60" width="48" height="48"></a> <a href="https://github.com/bedrin">bedrin</a> maintains <a href="https://github.com/bedrin/jdbc-sniffer">Jdbc-sniffer</a></p>


      </div>
      <div class="creds">
        <small>This page generated using <a href="https://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/bedrin/jdbc-sniffer/tarball/master" class="tar">tar</a><a href="https://github.com/bedrin/jdbc-sniffer/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-57642104-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

</body>
</html>
