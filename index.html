<!doctype html>
<!-- The Time Machine GitHub pages theme was designed and developed by Jon Rohan, on Feb 7, 2012. -->
<!-- Follow him for fun. http://twitter.com/jonrohan. Tail his code on http://github.com/jonrohan -->
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <link rel="stylesheet" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" href="stylesheets/pygment_trac.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/script.js"></script>

  <title>Jdbc-sniffer</title>
  <meta name="description" content="JDBC Sniffer">

  <meta name="viewport" content="width=device-width,initial-scale=1">

</head>

<body>

  <div class="wrapper">
    <header>
      <h1 class="title">Jdbc-sniffer</h1>
    </header>
    <div id="container">
      <p class="tagline">JDBC Sniffer</p>
      <div id="main" role="main">
        <div class="download-bar">
        <div class="inner">
          <a href="https://github.com/bedrin/jdbc-sniffer/tarball/master" class="download-button tar"><span>Download</span></a>
          <a href="https://github.com/bedrin/jdbc-sniffer/zipball/master" class="download-button zip"><span>Download</span></a>
          <a href="https://github.com/bedrin/jdbc-sniffer" class="code">View Jdbc-sniffer on GitHub</a>
        </div>
        <span class="blc"></span><span class="trc"></span>
        </div>
        <article class="markdown-body">
          <h1>
<a id="jdbc-sniffer" class="anchor" href="#jdbc-sniffer" aria-hidden="true"><span class="octicon octicon-link"></span></a>JDBC Sniffer</h1>

<p><a href="https://travis-ci.org/bedrin/jdbc-sniffer"><img src="https://travis-ci.org/bedrin/jdbc-sniffer.svg?branch=develop" alt="CI Status"></a>
<a href="https://coveralls.io/r/bedrin/jdbc-sniffer?branch=master"><img src="https://coveralls.io/repos/bedrin/jdbc-sniffer/badge.png?branch=master" alt="Coverage Status"></a>
<a href="https://maven-badges.herokuapp.com/maven-central/com.github.bedrin/jdbc-sniffer"><img src="https://maven-badges.herokuapp.com/maven-central/com.github.bedrin/jdbc-sniffer/badge.svg?style=flat" alt="Maven Central"></a></p>

<p>JDBC Sniffer counts the number of executed SQL queries and provides an API for validating it
It is very useful in unit tests and allows you to test if particular method doesn't make more than N SQL queries</p>

<h1>
<a id="maven" class="anchor" href="#maven" aria-hidden="true"><span class="octicon octicon-link"></span></a>Maven</h1>

<p>JDBC Sniffer is available from Maven Central repository</p>

<div class="highlight highlight-xml"><pre>&lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.github.bedrin&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;jdbc-sniffer&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;1.4&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre></div>

<p>For Gradle users:</p>

<div class="highlight highlight-javascript"><pre>dependencies {
    compile <span class="pl-s1"><span class="pl-pds">'</span>com.github.bedrin:jdbc-sniffer:1.4<span class="pl-pds">'</span></span>
}</pre></div>

<h1>
<a id="download" class="anchor" href="#download" aria-hidden="true"><span class="octicon octicon-link"></span></a>Download</h1>

<ul>
<li><a href="https://github.com/bedrin/jdbc-sniffer/releases/download/1.4/jdbc-sniffer-1.1.jar">jdbc-sniffer-1.4.jar</a></li>
<li><a href="https://github.com/bedrin/jdbc-sniffer/releases/download/1.4/jdbc-sniffer-1.1-sources.jar">jdbc-sniffer-1.4-sources.jar</a></li>
<li><a href="https://github.com/bedrin/jdbc-sniffer/releases/download/1.4/jdbc-sniffer-1.1-javadoc.jar">jdbc-sniffer-1.4-javadoc.jar</a></li>
</ul>

<h1>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup</h1>

<p>Simply add jdbc-sniffer.jar to your classpath and add <code>sniffer:</code> prefix to the JDBC connection url
For example <code>jdbc:h2:~/test</code> should be changed to <code>sniffer:jdbc:h2:~/test</code>
The sniffer JDBC driver class name is <code>com.github.bedrin.jdbc.sniffer.MockDriver</code></p>

<h1>
<a id="junit-integration" class="anchor" href="#junit-integration" aria-hidden="true"><span class="octicon octicon-link"></span></a>JUnit Integration</h1>

<p>JDBC Sniffer supports integration with JUnit framework via <code>@Rule</code></p>

<p>Add a <code>QueryCounter</code> rule to your test and assert the maximum number of queries allowed for particular test using <code>@AllowedQueries(n)</code> and <code>@NotAllowedQueries</code> annotations</p>

<div class="highlight highlight-java"><pre><span class="pl-k">package</span> <span class="pl-smp">com.github.bedrin.jdbc.sniffer.junit</span>;

<span class="pl-k">import</span> <span class="pl-smi">org.junit.BeforeClass</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.junit.Rule</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.junit.Test</span>;
<span class="pl-k">import</span> <span class="pl-smi">org.junit.rules.ExpectedException</span>;

<span class="pl-k">import</span> <span class="pl-smi">java.sql.Connection</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.sql.DriverManager</span>;
<span class="pl-k">import</span> <span class="pl-smi">java.sql.SQLException</span>;

<span class="pl-s">public</span> <span class="pl-s">class</span> <span class="pl-en">QueryCounterTest</span> {

    <span class="pl-st">@Rule</span>
    <span class="pl-s">public</span> <span class="pl-stj">ExpectedException</span> thrown <span class="pl-k">=</span> <span class="pl-stj">ExpectedException</span><span class="pl-k">.</span>none();

    <span class="pl-st">@Rule</span>
    <span class="pl-s">public</span> <span class="pl-stj">QueryCounter</span> queryCounter <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-stj">QueryCounter</span>();

    <span class="pl-st">@BeforeClass</span>
    <span class="pl-s">public</span> <span class="pl-s">static</span> <span class="pl-st">void</span> <span class="pl-en">loadDriver</span>() <span class="pl-s">throws</span> <span class="pl-stj">ClassNotFoundException</span> {
        <span class="pl-stj">Class</span><span class="pl-k">.</span>forName(<span class="pl-s1"><span class="pl-pds">"</span>com.github.bedrin.jdbc.sniffer.MockDriver<span class="pl-pds">"</span></span>);
    }

    <span class="pl-st">@Test</span>
    <span class="pl-st">@AllowedQueries</span>(<span class="pl-c1">1</span>)
    <span class="pl-s">public</span> <span class="pl-st">void</span> <span class="pl-en">testAllowedOneQuery</span>() <span class="pl-s">throws</span> <span class="pl-stj">SQLException</span> {
        <span class="pl-stj">Connection</span> connection <span class="pl-k">=</span> <span class="pl-stj">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s1"><span class="pl-pds">"</span>sniffer:jdbc:h2:~/test<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s1"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
    }

    <span class="pl-st">@Test</span>
    <span class="pl-st">@NotAllowedQueries</span>
    <span class="pl-s">public</span> <span class="pl-st">void</span> <span class="pl-en">testNotAllowedQueries</span>() <span class="pl-s">throws</span> <span class="pl-stj">SQLException</span> {
        <span class="pl-stj">Connection</span> connection <span class="pl-k">=</span> <span class="pl-stj">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s1"><span class="pl-pds">"</span>sniffer:jdbc:h2:~/test<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
        connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s1"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
        thrown<span class="pl-k">.</span>expect(<span class="pl-stj">AssertionError</span><span class="pl-k">.</span>class);
    }

}</pre></div>

<h1>
<a id="sniffer-api" class="anchor" href="#sniffer-api" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sniffer API</h1>

<p>The number of executed queries is available via static methods of several classes:
<code>com.github.bedrin.jdbc.sniffer.Sniffer</code>, <code>com.github.bedrin.jdbc.sniffer.ThreadLocalSniffer</code> and <code>com.github.bedrin.jdbc.sniffer.OtherThreadsSniffer</code></p>

<p>First one holds the number of SQL queries executed by all threads, second one holds the number of SQL queries generated by current thread only, and the last one counts SQL queries executed by all threads except for the current one</p>

<div class="highlight highlight-java"><pre>@<span class="pl-stj">Test</span>
<span class="pl-s">public</span> <span class="pl-st">void</span> testExecuteStatement() throws <span class="pl-stj">ClassNotFoundException</span>, <span class="pl-stj">SQLException</span> {
    <span class="pl-c">// Just add sniffer: in front of your JDBC connection URL in order to enable sniffer</span>
    <span class="pl-stj">Connection</span> connection <span class="pl-k">=</span> <span class="pl-stj">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s1"><span class="pl-pds">"</span>sniffer:jdbc:h2:~/test<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
    <span class="pl-c">// Sniffer.reset() sets the internal counter of queries to zero</span>
    <span class="pl-stj">Sniffer</span><span class="pl-k">.</span>reset();
    <span class="pl-c">// You do not need to modify your JDBC code</span>
    connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s1"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>);
    <span class="pl-c">// Sniffer.executedStatements() returns count of execute queries</span>
    assertEquals(<span class="pl-c1">1</span>, <span class="pl-stj">Sniffer</span><span class="pl-k">.</span>executedStatements());
    <span class="pl-c">// Sniffer.verifyNotMoreThanOne() throws an AssertionError if more than one query was executed;</span>
    <span class="pl-c">// it also resets the counter to 0</span>
    <span class="pl-stj">Sniffer</span><span class="pl-k">.</span>verifyNotMoreThanOne();
    <span class="pl-c">// Sniffer.verifyNotMore() throws an AssertionError if any query was executed</span>
    <span class="pl-stj">Sniffer</span><span class="pl-k">.</span>verifyNotMore();
}</pre></div>

<p>If you want to count the number of queries generated by a particular block of code, JDBC Sniffer provides a convenient functional API:</p>

<div class="highlight highlight-java"><pre>@<span class="pl-stj">Test</span>
<span class="pl-s">public</span> <span class="pl-st">void</span> testFunctionalApi() throws <span class="pl-stj">SQLException</span> {
    <span class="pl-s">final</span> <span class="pl-stj">Connection</span> connection <span class="pl-k">=</span> <span class="pl-stj">DriverManager</span><span class="pl-k">.</span>getConnection(<span class="pl-s1"><span class="pl-pds">"</span>sniffer:jdbc:h2:~/test<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>, <span class="pl-s1"><span class="pl-pds">"</span>sa<span class="pl-pds">"</span></span>);
    <span class="pl-c">// Sniffer.execute() method executes the lambda expression and returns an instance of RecordedQueries</span>
    <span class="pl-c">// this class provides methods for validating the number of executed queries</span>
    <span class="pl-stj">Sniffer</span><span class="pl-k">.</span>execute(() <span class="pl-k">-</span><span class="pl-k">&gt;</span> connection<span class="pl-k">.</span>createStatement()<span class="pl-k">.</span>execute(<span class="pl-s1"><span class="pl-pds">"</span>SELECT 1 FROM DUAL<span class="pl-pds">"</span></span>))<span class="pl-k">.</span>verifyNotMoreThanOne();
}</pre></div>

<h1>
<a id="building" class="anchor" href="#building" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building</h1>

<p>JDBC sniffer is built using JDK8+ and Maven 3+ - just checkout the project and type <code>mvn install</code>
JDK8 is required only for building the project - once it's built, you can use JBC sniffer with JRE 1.6+</p>
        </article>
      </div>
    </div>
    <footer>
      <div class="owner">
      <p><a href="https://github.com/bedrin" class="avatar"><img src="https://avatars0.githubusercontent.com/u/4654384?v=3&amp;s=60" width="48" height="48"></a> <a href="https://github.com/bedrin">bedrin</a> maintains <a href="https://github.com/bedrin/jdbc-sniffer">Jdbc-sniffer</a></p>


      </div>
      <div class="creds">
        <small>This page generated using <a href="http://pages.github.com/">GitHub Pages</a><br>theme by <a href="https://twitter.com/jonrohan/">Jon Rohan</a></small>
      </div>
    </footer>
  </div>
  <div class="current-section">
    <a href="#top">Scroll to top</a>
    <a href="https://github.com/bedrin/jdbc-sniffer/tarball/master" class="tar">tar</a><a href="https://github.com/bedrin/jdbc-sniffer/zipball/master" class="zip">zip</a><a href="" class="code">source code</a>
    <p class="name"></p>
  </div>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-57642104-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

</body>
</html>
